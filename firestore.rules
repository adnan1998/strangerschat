/**
 * Core Philosophy: This ruleset secures a real-time anonymous chat application.
 * It is designed to be permissive for authenticated users to facilitate rapid
 * development and testing, while still protecting user data from unauthenticated
 * access and preventing users from modifying each other's private data.
 *
 * Data Structure:
 * - /users/{userId}: Private user profiles, only writable by the owner.
 * - /online_users/{userId}: Public list of online users. Users manage their own
 *   presence, and this list is readable by anyone to facilitate starting new chats.
 * - /chat_rooms/{chatRoomId}: Chat room metadata.
 * - /chat_rooms/{chatRoomId}/messages/{messageId}: Messages within a room.
 *
 * Key Security Decisions:
 * - Open Read Access for Online Users: The `/online_users` collection is publicly
 *   readable to allow clients to build a list of who is online.
 * - Ownership-Based Writes: Users can only write to their own documents in the
 *   `/users` and `/online_users` collections.
 * - Participant-Based Chat Access: Access to a private chat room and its messages
 *   is controlled by the `participantIds` array in the chat room document. This
 *   avoids insecure cross-document reads in the rules.
 * - Global Chat: The 'global' chat room is open for any authenticated user to
 *   read and write messages.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //================================================================================
    // Helper Functions
    //================================================================================

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     * Use for documents that are owned by a specific user.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the requesting user is a participant of a private chat room.
     */
    function isChatParticipant(chatRoomId) {
      // Allow if the user's UID is in the participantIds list of the chat room.
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.participantIds;
    }

    /**
     * Validates that the ID inside a new user document matches the document ID.
     */
    function isValidNewUser(userId) {
      let data = request.resource.data;
      return data.id == userId &&
             data.username is string && data.username.size() >= 3 && data.username.size() <= 15 &&
             data.gender is string && (data.gender == 'Male' || data.gender == 'Female') &&
             data.age is number && data.age >= 18 && data.age <= 99 &&
             data.isOnline == true;
    }
    
    /**
     * Validates a new message has the correct sender and chat room link.
     */
    function isValidNewMessage(chatRoomId) {
      let data = request.resource.data;
      return data.chatRoomId == chatRoomId &&
             data.senderId == request.auth.uid &&
             data.content is string && data.content.size() > 0 &&
             request.time == data.timestamp;
    }

    //================================================================================
    // Collection Rules
    //================================================================================

    /**
     * @description Manages private user profile data. Only the user can read/write their own profile.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    /**
     * @description Manages public online presence. Any authenticated user can see who is online.
     * Only the user themselves can create or delete their own presence document.
     * @path /online_users/{userId}
     */
    match /online_users/{userId} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId);
    }
    
    /**
     * @description Manages all chat rooms, both global and private.
     * @path /chat_rooms/{chatRoomId}
     */
    match /chat_rooms/{chatRoomId} {
      // General rule: Allow read/write access to participants of the chat.
      allow read, write: if isChatParticipant(chatRoomId);

      // Anyone authenticated can create a private chat room as long as they are a participant.
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participantIds;

      // Rules for the messages subcollection within a chat room.
      match /messages/{messageId} {
        // Participants of the chat can read, list, and create messages.
        allow read, list, create: if isChatParticipant(chatRoomId);
        
        // Messages are immutable once created.
        allow update, delete: if false;
      }
    }

    /**
     * @description Specific override for the GLOBAL chat room to be more open.
     * Any signed-in user can read, write messages, and create the room.
     * @path /chat_rooms/global
     */
    match /chat_rooms/global {
      allow read, create: if isSignedIn();

      // No one can update or delete the global room itself.
      allow update, delete: if false;

      // Messages in the global chat room.
      match /messages/{messageId} {
        // Any signed-in user can read and create messages in the global chat.
        allow read, list, create: if isSignedIn();
        // Messages are immutable.
        allow update, delete: if false;
      }
    }
  }
}
